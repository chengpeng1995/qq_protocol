# -*- coding: utf-8 -*-
import time
import threading
import random,re
from mode import JceFactory
from mode import JceOutput as out
from Tools import Coder
from Tools import MD5
from Tools import TEA
from Tools import HexPacket
from Tools import Img
import Keys
from Tlv import Tlv
from RawSocket import RawSocket
import config




def decode(data):

    packet = TEA.detea_hexstr(data, '00'*16)
    value1 = re.findall('0307000000000200000000000000000101(.*)',packet)[0]
    value2 = value1[:32]
    print 'randomKey',value2
    value1 = value1[36:]
    print value1
    lenstr = Coder.hexstr2num(value1[:4])*2
    print 'pubKey 长度',lenstr
    pubKey = value1[4:][:lenstr]
    print 'pubKey ',pubKey
    if pubKey in Keys.pubKeys:
        print '有'
    else:
        print '没有'
    tlvstr = value1[4+lenstr:][:-2]
    print 'tlv加密前', tlvstr
    lll = TEA.detea_hexstr(tlvstr, '08C1A214C4E76086152128B59784D1AA')
    print 'tlv',lll
    return lll
def tlvdecode(value):
    data = value[8:] #去掉头

    #TLV18
    data = data[8:]
    data = data[28:]
    qqnum = data[:8]
    print qqnum
    data = data[8:]
    data = data[8:]

    #TLV1
    value = data[4:]
    value = value[16:]
    qqnum = value[:8]
    value = value[8:]
    print qqnum
    value = value[8:] #时间
    value = value[12:]
    print value

    #TLV106

    value1 = value[4:] #01 06
    lenstr1 = Coder.hexstr2num(value1[:4])*2
    str = value1[4:][:lenstr1]
    print '106加密前',str

    pwdKey = Coder.hash_qqpwd_hexstr('188075889', 'qw6012827')
    print 'pwdKey',pwdKey
    string = TEA.detea_hexstr(str, pwdKey)
    print '106解密后',string

    value = string[4:]
    value = value[8:]
    value = value[32:]
    value = value[16:]
    value = value[10:]
    pwdmd5 = MD5.md5_hex('qw6012827')
    print pwdmd5
    value = value[32:]
    tgtKey = value[:32]
    print 'tgtKey',tgtKey



hhh = decode('396a57aab769ad8a56d55f6b463f4cb857fc7fa43a7d7c69526fa89715c0d2ea17986d95030c193535fbbb415c137332ebd40b6d50dea9237574fdfa067087810f2c81fd2822105bec69150e387b005952cdfd4e62e08a4e733c84cd47dd05fcc7bb07da80e3f9398704cfbe95176802194c71803ae9f01cfd7c7b427c3b89b454f319ee46b435895ce66d70245c96671bce669b736bc122693b6af92aa2837a95627f5ddd1229cd61eb0a4370eaf894db84db33149290cbf8cd41f6b97a7263c580b488701667d67ddcd1586064a800c7d58c73c8ed16afac5d153206849c630b23778518a5e38440629f40751067bb56bda6c61adb8a8fca7c03b0a90a54f71cf31edb4c10e48561deb3a2aac0abff6a0eef235635891e1e62122e4308a954649d04a726e474de6dcb36077cabeed574af53442f048373792af206033bb18f7136f12537d89f844361e888be67bbe92096f95661d5cb01b2aceafe11f1290c6b374ed9c7d4c27a12bb17120ba3d48106af4544eee8b0e29f99777db9e84dff44b4ab10d0a3706115398a6aa173daf7b03872d5c3ff1360a0a93455a5fe537b29459ec57c2371a4a0f6cb2f384fd9e41410e7379ab91380555df81dab8ff4ea66f9188abfbfb9f3c8eabe4d3de1184af88227656e3e9e95c20cd7e1725a159f786d3580845869a34e284ec935b3a7600be84a6478b04ea27141a0ea6169c0fe6a877da569c2813e2eb5e33b8d09de80eec3a0ee369e440a78dc80326476747715fd7679f9d7d4f58ee21e74f46dcebf3fdf7460fb5734cbfb1862f8432ac09289f02d36498cc146726bf5e8979e711eff261ad0a45c5c646377f2d8a749d8b5107df5942b8096f7f8b21334ceb1fb2c027736448a2bbb908de1a014de93e04a32b42cc80e11416dfd348e817c3fd88f220d8db6cdeead1fecfb76dabef052c0cf2ca20cdc2dbd6457744d427713682342d87e38b653fcf2052d18152f6c95133a44fbe481471d3cff359ea7bf159c001eac776d4929ca1fecae4b7c4b289ee0e17d09c7cb490431ed2facdf37c50ef9e8c5e4f90b43cc2e46c68f7fd5f263d8711ef282564234cd15e09c0e0407d8a57365eedf39b09e1f7efaa16c1cc8d0e08fb9aa70e70bdb620830ab423a0568ecc7172ff18311c423daac067e8e0893882b082bb583ed2ea4591761d5509ddb94080e910aafe090aaf9d2281f495e0657e94c232cd64c15022b305b516604ed5178f3e9cd4d0d56351c28cd818d896e53135beb21c88cf9d7006f8e5bd62ba5ee')
#print '03C4D52B36E7F12E7B52E3F18030FCD8CFFDA24BDD49108C24'
#print '7EF18AD02A7E08D7552B54F0A1CAB854'

#9900010a0101cc100121361f31179240ff0b0b1a02580ebe081201ce34572207271ce23c4301c9bd4000b785405612e6b599e6b19fe79c81e69dade5b79ee5b8826d0000130d000c1c2301c9c38000b78b803c4c50ff6c7c0b200130ff5d000001006c7107d080ff9cccd001ecfc0ffc10f11101e0fc12fc13fc14f01501fc16f0180ffd1900000e1800200028003000380040004a00fc1afc1bfc1cf61da27b226474797065223a312c226d756964223a223844463945323646383944444333394545413946333236393131373444313743222c2263617272696572223a322c22636f6e6e223a312c22706f7377223a3231362c22706f7368223a3135302c226c6174223a33303239313033312c226c6e67223a3132303030333831302c22635f6f73223a22616e64726f6964222c22635f6f73766572223a22352e312e31227df01e3ffc1ff020030b8c980ca80c



tlvdecode(hhh)

'0000002d'
'0000271000000000000000040000001177746c6f67696e2e6c6f67696e000000081e9c8d0700000000000004350204311f4108100001b942a78e0000000311dcc761cbb7b4983eecc3cb4cfb6fce9d0e99b584f1e9220dfc0c9a5956743c20011e3e96c33b7365c83180c6d12332a3fcb328152d9e2b991bff404c7d3a2e423e9c04826f190d92ded2d81730e9dd097474314983cfe8f4689bda7bac338b7c59386f45b55d8f7597682b1ce70f1eddaa3304f21357ab19ee15f47c22910db29e002d62b2ccb8b5f558167a4694cd5b9e61659c8961fae2006e11b7e385bd938089e0eb6fc73301adb53516d65c02b35733702547114903bdcd789952d9b0429d7536e4a687a6b7484f18d876fe6ce916eb58a72dc8fc006484730ddae7a921e50252422124ca3228206562487d00085a13c3ac09485b620ad65f101f1a3e29064614b626e582c89abafe676c8e51565451e6d0e2ff3f46c83d13b9955880eced23f52460ddd3c1cf6d5e36ffa321daf42c15e43e279f8b09481565aea650039d5fe74a8c5af046828ae01b7e8f94b53625a06d0dfb1a13a71a035a5bc7e8fc2aeb447b179dda27d2386d5531839f4296a4e594469dd6e1957baaba68e1d75afbd8eb1bf3102ad5d5e86fce1794a4f0c0dd8f0356b59f66b5762ce17994d8a188950b6c8887bf5696955194cf768008a6d9af87b3e8108929427532db3ae89d361d36dfd07a9e0285ad84c65b4779c51a643b91c9233ef2521e9856c15d13c05aa54d77531bfc913a2e428501b12cae5ca6e8eeed0385e8fb537fb854335e4539ec4277ae5256393291be27aae05caa6f40cdc72cd9997d911313bcbffd968c5d07205477034bfe9f40a34dea5ef5b7da35dbec33b3d339b78ee8443274be0f9d0e1b27604f1377704bb2ed78dc14c40558ed8670b7dc9773d335dae549b2b114b56a7dfc4650b97fb7e83ba4fde70b958646e1862ad78b82a66e762e67b7c1b3a89299d5859a4ec4183ce0bc8b973fec563ebeac473a5610f5fb1cc34d9ac98edfa5f8c059354790a6250d5c471444343f6d7e9f03f9671ed0587abe3c67c7de1c96866e4b652b8755f099c99309c8ec95dd4ac10e5d995dfb9283d531bb11295fe0502000a51c16b9861275895f74cf3a9cda2ef2d6dbb73e8322aaccac56005d98465ac6c00b2c97bca7665c76c81db82bbb40ff9b2e15591137b32dae273f0e65cadb6f521b4a2dd31ef0abc1d281a306b8e81dd14c3c64e853f869f35e8cb7fc3215808662c57ff02ea3f7b117cd3f87c55de06f90904427ade326c523299214c7902a78655822a6809d24212cecdc0c987baa4fd61629458be24ee09d63b711936f4ababec2fae783512946fcb0912659efe39304bafbad17a43bc3674686939409ed63ec4d5d9de0bfa6b810b45bc7f0eeda26a6811b1bb3ff360f0dbc3b969891ad4c0eeea0169b8f880c8f8e3d219e41dd100a27efdf8ce50e0a0fac82e0a6cae198d03b7888109fd65dc895e5385d7588879433ab4a367372f2b673b5fcb577d2a54ab0ac2d540e521522b0cb5bb9090d375c9e702ddc83aa03'
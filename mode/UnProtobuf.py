# -*- coding: utf-8 -*-

import Protobuf,re
import sys
reload(sys)
sys.setdefaultencoding('utf-8')
def UnMessageSvcPbGetMsg(data):
    data = data[8:]
    PB = Protobuf.protobuf(data)
    msglist = []
    targetQQ = PB.decode('->2a->10')
    list = PB.getWireTypeValueList('22',PB.decode('->2a'))
    for item in list:
        retdata = Friend_Message(targetQQ,item)
        if retdata:
            msglist.append(retdata)
    print msglist
    return msglist



    #if type == 166 and type1 == 11:



        #return [0,Friend_Message(targetQQ,data)]
   #elif type == 528 and type1 == 35:
       # return [1,Friend_add_request(data)]
    #else:
        #return [2,u'未知消息类型']




def Friend_add_request(data):
    PB = Protobuf.protobuf(data)
    try:
        targetQQ = PB.decode('->0a->78')
        return targetQQ
    except:
        pass
def Friend_Message(targetQQ,data):
    PB = Protobuf.protobuf(data)
    MsgID = PB.decode('->0a->28')
    type = PB.decode('->0a->18')
    type1 = PB.decode('->0a->20')
    if type == 166 and type1 == 11:
        messagedata = ''
        list = PB.getWireTypeValueList('12',PB.decode('->1a->0a'))
        for item in list:
            PB1 = Protobuf.protobuf(item)
            if item[:2] == '0a':#文字消息
                message = PB1.decode('->0a->0a').decode('hex')
                messagedata += '['+message+']'
            elif item[:2] == '22':#图片消息
                imgdata = PB1.decode('->22->7a').decode('hex')
                Imageurl = u'http://183.232.95.26'+imgdata
                messagedata += '[图片地址：'+Imageurl+']'
                imgpath = PB1.decode('->22->52')
                imgname = PB1.decode('->22->3a')
                messagedata += u'[图片路径：'+imgpath.decode('hex')+u']'+u'[图片名称：'+imgname+u']'
            elif item[:2] == '12':#表情消息
                code = PB1.decode('->12->08')
                messagedata += '['+str(code)+']'
        value = {'MsgID':MsgID,'targetQQ':targetQQ,'message':messagedata,'MsgType':1}
        return value
    elif type == 187 and type1 == 0:
        targetQQ = Friend_add_request(data)
        value = {'MsgID':MsgID,'targetQQ':targetQQ,'MsgType':1001}
        return value
    elif type == 84 and type1 == 0:
        GroupCode = PB.decode('->0a->08')
        targetQQ = Friend_add_request(data)
        value = {'MsgID':MsgID,'targetQQ':targetQQ,'GroupCode':GroupCode,'MsgType':2001}
        return value
def UnOnlinePushPbPushGroupMsg(data):

    data = data[8:]
    PB = Protobuf.protobuf(data)
    targetQQ = PB.decode('->0a->0a->08')
    target_nickname = PB.decode('->0a->0a->4a->22')
    MsgID = PB.decode('->0a->0a->28')
    groupQQ = PB.decode('->0a->0a->4a->08')
    group_nickname = PB.decode('->0a->0a->4a->42')
    messagedata = ''
    list = PB.getWireTypeValueList('12',PB.decode('->0a->1a->0a'))
    for item in list:
        PB1 = Protobuf.protobuf(item)
        if item[:2] == '0a':
            message = PB1.decode('->0a->0a').decode('hex')
            messagedata += '['+message+']'
        elif item[:2] == '12':
            emoticonCode = PB1.decode('->12->08')
            messagedata += '['+str(emoticonCode)+']'
        elif item[:2] == '42':
            img = PB1.decode('->42->82').decode('hex')
            ImageUrl = 'http://gchat.qpic.cn'+img
            messagedata += '['+ImageUrl+']'
    dict = {'targetQQ':targetQQ,'targetnickname':target_nickname.decode('hex'),'groupQQ':groupQQ,'groupnickname':group_nickname.decode('hex'),'message':messagedata,'MsgID':MsgID}
    return dict

def UnfriendlistSetGroupReq(data):
    PB = Protobuf.protobuf(data)
    id = PB.decode('->08')
    code = PB.decode('->10')
    return {'id':id,'code':code}

def UnGroupManager(pbdata):
    [data1,data2] = pbdata
    PB1 = Protobuf.protobuf(data1)
    FounderQQ = str(PB1.decode('->22->0a->1a->08'))
    ManagerQQList = []
    PB2 = Protobuf.protobuf(data2)
    list = PB2.getWireTypeValueList('22',PB2.decode('->22'))
    for item in list:
        pb = Protobuf.protobuf(item)
        ManagerQQList.append(str(pb.decode('->08')))
    return {'FounderQQ':FounderQQ,'ManagerQQList':ManagerQQList}
def UnLongConnOffPicUp(data):
    data = data[8:]
    PB1 = Protobuf.protobuf(data)
    return PB1.decode('->12->4a')


#UnLongConnOffPicUp('111111110801128302080010bce0ee7a1800280038e5c4bff30838b4b382cd03388c9ff7fb0638b78187960240903f4050405040504a800163c3e868083e3ef3f0fbbe5649fd0870b533c4fb9d8f1d0781053ac5eb91af2ae258fb4d8aa4265cf453f5aaccdf4cde17a375fc58c10ecdf9262ec3931918d72332df5d7df294f10b25a72f71ed5ff878cc660cd0a7865e17eae404cd7097cc544aff3e5a5fe1c42fb4ca17ca17d36e770e497086f7d8df21e8bd5abcbb5f6552252f63323336383138612d333266332d343163642d383039622d3637343766653130326239385a252f63323336383138612d333266332d343163642d383039622d3637343766653130326239386000688080022001')


# def ttt():
#     data = '0a2439333645453036424430333530393543393931433541323537323631344145342e6a706710b9d2031a252f64366531303266392d646337312d346132372d393738622d64643330623465633037303728eb073a10936ee06bd035095c991c5a2572614ae440c00748d00552252f64366531303266392d646337312d346132372d393738622d6464333062346563303730376800800103c001a18e01c801868902'
#     PB1 = Protobuf.protobuf(data)
#     return PB1.decode('->1a')
#
# print ttt().decode('hex')
#print UnGroupManager()
#print UnfriendlistSetGroupReq('08900410908484818080808002')




#PB = Protobuf.protobuf('080012001a3208a2fdb2bf0510a2fdb2bf051881d1bca60720a69fffe104288ad497ec0948a4b7bed80358a6bca4cc0a602368a2fdb2bf0520022a8a0508a1fdb2bf05108ecf8aca0b180122f7040a28088ecf8aca0b10f19ed75918a601200b28e94930a2fdb2bf053882ba93c08980808001b801bbb001120808011000180020001ac0040abd040a27080010a2fdb2bf051882ba93c00920002809300038860140004a0ce5beaee8bdafe99b85e9bb91129104228e040a1b54494b58254d5a425743244d304c355f2425417b5931462e6a706710adaf031a252f35313164636536612d663364302d343864642d383133622d663562313736376464633462226316202039393130203838314342202020202035353231336537443637414639354134314145333842454231444136363141323237444336442e6a7067662f35313164636536612d663364302d343864642d383133622d663562313736376464633462413a107d67af95a41ae38beb1da661a227dc6d40cd0448800852252f35313164636536612d663364302d343864642d383133622d6635623137363764646334625a041100000062562f6f66667069635f6e65772f333130383135333233302f2f35313164636536612d663364302d343864642d383133622d6635623137363764646334622f3139383f7675696e3d313838303735383839267465726d3d327a542f6f66667069635f6e65772f333130383135333233302f2f35313164636536612d663364302d343864642d383133622d6635623137363764646334622f303f7675696e3d313838303735383839267465726d3d329a0100a00101a801c601b00171d201562f6f66667069635f6e65772f333130383135333233302f2f35313164636536612d663364302d343864642d383133622d6635623137363764646334622f3430303f7675696e3d313838303735383839267465726d3d32d8018003e001dc0130012a0f08cba7b2bf0510f19ed759180130012a1008cffbb1bf0510ebeea0eb0a180130012a1008a4caa3bf0510fccec6ab0f18013001380042004800')
#print PB.decode('->2a->22->1a->0a->12->22->22').decode('hex')
#print Friend_Message('080012001a3208a2fdb2bf0510a2fdb2bf051881d1bca60720a69fffe104288ad497ec0948a4b7bed80358a6bca4cc0a602368a2fdb2bf0520022a8a0508a1fdb2bf05108ecf8aca0b180122f7040a28088ecf8aca0b10f19ed75918a601200b28e94930a2fdb2bf053882ba93c08980808001b801bbb001120808011000180020001ac0040abd040a27080010a2fdb2bf051882ba93c00920002809300038860140004a0ce5beaee8bdafe99b85e9bb91129104228e040a1b54494b58254d5a425743244d304c355f2425417b5931462e6a706710adaf031a252f35313164636536612d663364302d343864642d383133622d663562313736376464633462226316202039393130203838314342202020202035353231336537443637414639354134314145333842454231444136363141323237444336442e6a7067662f35313164636536612d663364302d343864642d383133622d663562313736376464633462413a107d67af95a41ae38beb1da661a227dc6d40cd0448800852252f35313164636536612d663364302d343864642d383133622d6635623137363764646334625a041100000062562f6f66667069635f6e65772f333130383135333233302f2f35313164636536612d663364302d343864642d383133622d6635623137363764646334622f3139383f7675696e3d313838303735383839267465726d3d327a542f6f66667069635f6e65772f333130383135333233302f2f35313164636536612d663364302d343864642d383133622d6635623137363764646334622f303f7675696e3d313838303735383839267465726d3d329a0100a00101a801c601b00171d201562f6f66667069635f6e65772f333130383135333233302f2f35313164636536612d663364302d343864642d383133622d6635623137363764646334622f3430303f7675696e3d313838303735383839267465726d3d32d8018003e001dc0130012a0f08cba7b2bf0510f19ed759180130012a1008cffbb1bf0510ebeea0eb0a180130012a1008a4caa3bf0510fccec6ab0f18013001380042004800')
#UnOnlinePushPbPushGroupMsg('000000ad0a9b010a4108f19ed75910f19ed7591852200028a801308e8ab2bf0538d280b88480808080024a1508fcedd36c1001187322012d30024205746573743150005800600088010812060801100018001a4e0a4c0a190801100118002000280a300038860140024a06e5ae8be4bd9312100a0e0a0ce4bda0e5a5bde5958a21212112044a024003120c8201090a012d1802200828011209aa0206500060016800108ade8ebcfdffffffff')

#print 'c2a0'.decode('hex')

#UnMessageSvcPbGetMsg('0000031a080012001a2408fefff1bf0510fefff1bf05288a92a2e80e48e7d99ddd0858d6ae96810968fefff1bf0520022a880508a2fcf1bf0510889fb78d01180122f5040a2808889fb78d0110f19ed75918a601200b28ffb70130fefff1bf0538e9d983d38780808001b801e551120808011000180020001abe040abb040a27080010fdfff1bf0518e9d983d3072000280a300038860140314a0ce5beaee8bdafe99b85e9bb91128f04228c040a1b424c522930453434567b59285d414a4c4b4043474942512e6a706710c691041a252f64386537323565322d653633362d343139622d613837332d626532663131306533316634226316202039393130203838314342202020202036373738326546424436453746384244363044354530384136393337323530333641423342462e6a7067662f64386537323565322d653633362d343139622d613837332d626532663131306533316634413a10fbd6e7f8bd60d5e08a693725036ab3bf409a0548f40352252f64386537323565322d653633362d343139622d613837332d6265326631313065333166345a041100000062552f6f66667069635f6e65772f3239363630333532382f2f64386537323565322d653633362d343139622d613837332d6265326631313065333166342f3139383f7675696e3d313838303735383839267465726d3d327a532f6f66667069635f6e65772f3239363630333532382f2f64386537323565322d653633362d343139622d613837332d6265326631313065333166342f303f7675696e3d313838303735383839267465726d3d329a0100a00101a8019401b001c601d201552f6f66667069635f6e65772f3239363630333532382f2f64386537323565322d653633362d343139622d613837332d6265326631313065333166342f3430303f7675696e3d313838303735383839267465726d3d32d801a002e001800330012a0f0890c7e7bf0510f19ed759180130012a1008b6faf0bf0510ebeea0eb0a180130012a100891c7e7bf05108befe89102180130012a1008a5c7e7bf0510fccec6ab0f180130012a100894c7e7bf0510fe87a6df0e180130013800420048')